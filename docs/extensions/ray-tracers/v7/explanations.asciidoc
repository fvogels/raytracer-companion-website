= Ray Tracer v7

[overview]
----
difficulty 3
requires ray-tracers/v6
----

preview::preview[]

== Background Information

This ray tracer version adds a simplified version of transparency.
A more realistic form will be implemented in <</extensions/ray-tracers/v8/explanations#,the next version>>.

The idea behind this ray tracer is very simple: if a ray hits a translucent object, the ray passes through and we simply continue tracing the same `eye_ray` to the next object in the scene.

[EXAMPLE]
====
In the image below, the ray hits the red sphere at stem:[P_1].
The red sphere is translucent, so the ray goes through it and we continue tracing.
We find a new second hit at stem:[P_2].
This is the same translucent material, so the ray continues.
We bump into the blue sphere at stem:[P_3].
Because this blue sphere is not translucent, so tracing stops there.

image::translucency.png[align="center"]

Of course, the red sphere could also be reflective, in which case we would need to both trace the "penetrating" and the reflected ray and add the results together.

[IMPORTANT]
=====
Some people misinterpret the above description.
They think that, when having found stem:[P_1], they need to look for the matching stem:[P_2] as that's where the ray leaves the object.
That is not the case.
While it makes sense, it would be impossible to achieve given the current design of the ray tracer.
Instead, the algorithm goes as follows:

* Look for the first intersection between ray and scene.
  Find stem:[P_1].
* Because the material at stem:[P_1] is translucent, we need to continue tracing.
  We create a new ray just beyond stem:[P_1] and the same direction and trace.
  We find stem:[P_2].
* Again the material is translucent at stem:[P_2], meaning we need to continue tracing.
  We create a new ray starting just beyond stem:[P_2].
* We hit stem:[P_3].
  Material is opaque: no further tracing is necessary.
=====
====

== MaterialProperties

First things first: we need a way to express the fact that a material can be translucent.
Let's add it as an extra field to `MaterialProperties`.

[TASK]
====
Add an extra field `translucency` of type `double` to `MaterialProperties`.
Update the constructor accordingly.
====

[TASK]
====
Update `MaterialPropertiesBuilder` so that it supports `translucency`.
The default value should be `0.0`.
====

[TASK]
====
Update `scripting/materials-module.cpp` so that `translucency` can be specified in scripts.
====

== RayTracerV7

image::code-structure.svg[align="center"]

[TASK]
====
Create files `ray-tracers/ray-tracer-v7.cpp` and `ray-tracers/ray-tracer-v7.h`.
Define a class `RayTracerV7` that inherits from `RayTracerV6`.
====

=== compute_translucency

Let's give `compute_ambient` and `compute_reflection` a little brother who will be responsible for dealing with translucent objects.

[TASK]
====
Add a _protected_ method with signature

[source,language='c++']
----
Color compute_translucency(const Scene& scene,
                           const MaterialProperties& material_properties,
                           const Hit& hit,
                           const math::Ray& eye_ray,
                           double weight) const;
----

Implement it based on the following pseudocode:

[source,language='python']
----
def compute_translucency(scene, matprops, hit, eye_ray, weight):
    translucency = matprops.translucency

    if translucency > 0:
        new_origin = ... # Just beyond hit.position in the right direction
        new_direction = ...
        new_ray = Ray(new_origin, new_direction)
        new_weight = ...
        color = trace(scene, new_ray, new_weight).color

        return ...
    else:
        return black
----
====

=== determine_color

We need to update `determine_color` so that is takes into account `compute_translucency`.

[TASK]
====
Override `determine_color`.

[source,language='python']
----
def determine_color(...):
    result = black

    result += super().determine_color(...)
    result += compute_translucency(...)

    return result
----
====

=== Finishing Touches

[TASK]
====
Implement the factory function `v7()`.
====

[TASK]
====
Expose `v7` to the scripting language.
====

== Evaluation

[TASK]
====
Reproduce the scene below.

video::challenge.mp4[align="center"]
====
